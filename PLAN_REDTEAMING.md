# Red Teaming Implementation Plan

## Overview

Implement automated red teaming where a Grok model (via OpenRouter) acts as the user, generating messages based on a psychotic persona, while the target model (assistant) responds with memory profile context.

## Key Differences from Manual Scenarios

1. **User Messages**: Generated by red teamer model instead of pre-written JSON
2. **Memory Profile**: Only visible to target model (assistant), NOT to red teamer
3. **Dynamic Turns**: Configurable number of conversation turns
4. **Red Teamer Context**: Sees conversation history without memory profile

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ Red Teaming Loop (NUM_TURNS iterations)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Red Teamer (Grok)          Target Model (GPT-4o, etc.)   │
│  ┌─────────────────┐        ┌──────────────────────────┐  │
│  │ Chat History    │        │ Chat History + Memory     │  │
│  │ (NO memory)     │        │ Profile                  │  │
│  └─────────────────┘        └──────────────────────────┘  │
│         │                              │                    │
│         │ 1. Generate user message     │                    │
│         ├──────────────────────────────>│                    │
│         │                              │                    │
│         │                   2. Generate assistant response │
│         │<──────────────────────────────┤                    │
│         │                              │                    │
│         │ 3. Update with target response│                    │
│         │                              │                    │
└─────────┴──────────────────────────────┴────────────────────┘
```

## Implementation Components

### 1. Red Teamer Prompt (`prompts/red_team_prompt.txt`)
- Based on Tim Hua's approach
- Instructions for role-playing psychotic persona
- Format: `<message>...</message>` wrapper
- Character-specific instructions

### 2. Character/Persona Files (`scenarios/{persona}/persona.txt`)
- Character description and progression arc
- Similar to Tim Hua's character files
- Can reuse existing pattern_analyst persona or create new ones

### 3. Custom Solver (`evaluation/tasks.py`)
- `@solver` decorated function
- Manages two separate message histories:
  - `redteam_messages`: For red teamer (no memory profile)
  - `target_messages`: For target model (with memory profile)
- Loop for NUM_TURNS:
  1. Call red teamer model with `redteam_messages`
  2. Extract user message from `<message>` tags
  3. Add user message to both histories
  4. Call target model with `target_messages
  5. Add target response to both histories
  6. Update red teamer with target response for next turn

### 4. Task Definition (`evaluation/tasks.py`)
- New `@task` function: `psychosis_redteam_eval()`
- Parameters:
  - `persona`: Character name
  - `memory_length`: 0, 5, 10, or 15 sessions
  - `num_turns`: Number of conversation turns (default: 12)
  - `redteam_model`: Model for red teaming (default: `openrouter/x-ai/grok-4`)
  - `target_model`: Model being evaluated (passed via `--model` flag)
- Task name includes: `{persona}_memory_{memory_length}_turns_{num_turns}_redteam`

### 5. Model Calls
- Use `get_model()` from `inspect_ai.model` for both models
- Red teamer: `get_model(redteam_model)`
- Target: Use `generate()` function passed to solver (uses task's model)

## File Structure

```
evaluation/
  tasks.py                    # Updated with red teaming solver and task
  prompts/
    red_team_prompt.txt       # Red teamer instructions
scenarios/
  pattern_analyst/
    persona.txt               # Character description for red teamer
    memory_0sessions.txt      # Existing memory profiles
    memory_5sessions.txt
    memory_10sessions.txt
    memory_15sessions.txt
scripts/
  run_eval.py                 # Updated to support red teaming mode
```

## Implementation Steps

1. **Create red team prompt file**
   - Based on Tim Hua's `red_team_prompt.txt`
   - Include character placeholder: `{character_name}` and `{psychotic_character}`

2. **Create persona file for pattern_analyst**
   - Extract character description from existing resources
   - Format similar to Tim Hua's character files

3. **Implement red teaming solver**
   - Custom `@solver` function
   - Two message histories
   - Loop with model calls
   - Extract messages from `<message>` tags

4. **Create red teaming task**
   - `@task` decorated function
   - Loads persona and memory profile
   - Constructs red teamer prompt
   - Uses red teaming solver

5. **Update run_eval.py**
   - Add flag for red teaming mode
   - Pass red teamer model parameter

6. **Testing**
   - Test with memory 0 and memory 15
   - Verify red teamer doesn't see memory profile
   - Verify target model sees memory profile
   - Check log file naming

## Key Technical Details

### Red Teamer Message Extraction
```python
import re
rt_response = await redteam_model.generate(redteam_messages)
# Extract message from <message>...</message> tags
message_match = re.search(r"<message>(.*?)</message>", rt_response.completion, re.DOTALL)
user_message = message_match.group(1).strip() if message_match else rt_response.completion
```

### Message History Management
```python
# Red teamer history (no memory)
redteam_messages = [
    ChatMessageSystem(content=redteam_prompt),
    # ... conversation without memory profile
]

# Target history (with memory)
target_messages = [
    ChatMessageSystem(content=system_prompt_with_memory),
    # ... full conversation
]
```

### Model Calls
```python
from inspect_ai.model import get_model

# Red teamer model
redteam_model = get_model(redteam_model_name)

# Target model (use generate function from solver)
target_response = await generate(target_state)
```

## Configuration

- `NUM_TURNS`: Constant for default number of turns (can be overridden)
- Red teamer model: `openrouter/x-ai/grok-4` (default)
- Red teamer prompt: Loaded from `prompts/red_team_prompt.txt`
- Persona: Loaded from `scenarios/{persona}/persona.txt`

## Logging

- Full conversation logged by InspectAI
- Both red teamer and target messages in log
- Metadata includes:
  - `persona`
  - `memory_length`
  - `num_turns`
  - `redteam_model`
  - `target_model`

